<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Avanc√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f0f2f5; --bg-secondary: #ffffff; --bg-tertiary: #e4e6eb; --bg-accent: #f0f2f5;
            --text-primary: #050505; --text-secondary: #6b7280; --border-color: #e2e8f0;
            --my-message-bg: #007aff; --my-message-text: #ffffff;
            --other-message-bg: #e5e5ea; --other-message-text: #000000;
        }
        html.dark {
            --bg-main: #1c1c1e; --bg-secondary: #2c2c2e; --bg-tertiary: #3a3a3c; --bg-accent: #2c2c2e;
            --text-primary: #ffffff; --text-secondary: #8e8e93; --border-color: #3a3a3c;
            --my-message-bg: #0b84fe; --my-message-text: #ffffff;
            --other-message-bg: #3a3a3c; --other-message-text: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); overflow: hidden; }
        .server-icon { width: 3rem; height: 3rem; background-color: var(--bg-tertiary); border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.5rem; cursor: pointer; transition: all 0.2s ease-in-out; }
        .server-icon:hover, .server-icon.active { border-radius: 1rem; }
        .server-icon.active { box-shadow: 0 0 0 3px var(--my-message-bg); }
        .server-icon img { width: 100%; height: 100%; object-fit: cover; }
        .modal-content { background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary); }
        .modal-overlay { background-color: rgba(0,0,0,0.6); }
        #message-list, #server-list { scrollbar-width: thin; scrollbar-color: var(--bg-tertiary) transparent; }
        .auth-input, .modal-input { background-color: var(--bg-accent); border-color: var(--border-color); }
        .tab { border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #007aff; color: #007aff; }
        html.dark .tab.active { border-bottom-color: #0b84fe; color: #0b84fe; }
        .message-row { display: flex; margin-bottom: 0.25rem; max-width: 75%; }
        .message-content { display: flex; flex-direction: column; }
        .message-bubble { padding: 0.5rem 0.85rem; border-radius: 1.25rem; word-wrap: break-word; line-height: 1.4; }
        .message-time { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .my-message { align-self: flex-end; }
        .my-message .message-bubble { background-color: var(--my-message-bg); color: var(--my-message-text); border-bottom-right-radius: 0.25rem; }
        .my-message .message-time { text-align: right; }
        .other-message { align-self: flex-start; }
        .other-message .message-bubble { background-color: var(--other-message-bg); color: var(--other-message-text); border-bottom-left-radius: 0.25rem; }
        .other-message .message-time { text-align: left; }
        .message-avatar { width: 2.25rem; height: 2.25rem; border-radius: 9999px; margin-right: 0.5rem; cursor: pointer; }
        .message-pseudo { font-size: 0.8rem; font-weight: 600; margin-bottom: 0.2rem; color: var(--text-secondary); cursor: pointer; }
    </style>
</head>
<body>

    <!-- #################### √âCRAN D'AUTHENTIFICATION #################### -->
    <div id="auth-screen" class="hidden items-center justify-center h-screen w-screen">
        <div class="modal-content p-8 rounded-xl shadow-lg w-full max-w-sm relative">
            <button id="auth-theme-toggle" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"></button>
            <div class="flex justify-center mb-6"><img src="https://placehold.co/150x50/ffffff/050505?text=ChatApp" alt="Logo" class="block dark:hidden h-12"><img src="https://placehold.co/150x50/242526/e4e6eb?text=ChatApp" alt="Logo" class="hidden dark:block h-12"></div>
            <div class="flex border-b border-border-color mb-6">
                <button id="login-tab-btn" class="tab flex-1 py-2 font-semibold">Se Connecter</button>
                <button id="signup-tab-btn" class="tab flex-1 py-2 font-semibold text-secondary">Cr√©er un compte</button>
            </div>
            <form id="login-form" class="hidden"><p id="login-error" class="text-red-500 text-sm mb-4 text-center hidden"></p><input type="text" id="login-username" placeholder="Pseudo (unique)" class="w-full p-3 border rounded-lg mb-4 auth-input" required><input type="password" id="login-password" placeholder="Mot de passe" class="w-full p-3 border rounded-lg mb-4 auth-input" required><button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700">Se connecter</button></form>
            <form id="signup-form" class="hidden"><p id="signup-error" class="text-red-500 text-sm mb-4 text-center hidden"></p><input type="text" id="signup-username" placeholder="Pseudo unique (ex: john_doe)" class="w-full p-3 border rounded-lg mb-2 auth-input" required><input type="text" id="signup-displayname" placeholder="Nom d'affichage (ex: John)" class="w-full p-3 border rounded-lg mb-4 auth-input" required><input type="password" id="signup-password" placeholder="Mot de passe (6+ caract√®res)" class="w-full p-3 border rounded-lg mb-4 auth-input" required><input type="url" id="signup-pfp" placeholder="URL de l'image (facultatif)" class="w-full p-3 border rounded-lg mb-4 auth-input"><button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700">Cr√©er le compte</button></form>
        </div>
    </div>

    <!-- #################### INTERFACE PRINCIPALE #################### -->
    <div id="main-app-screen" class="hidden h-screen w-screen flex text-primary">
        <nav id="server-list" class="w-20 bg-gray-200 dark:bg-gray-900 p-3 flex flex-col items-center gap-3 overflow-y-auto"></nav>
        <div id="chat-container" class="flex-grow flex flex-col bg-secondary">
            <header class="bg-white dark:bg-gray-800 border-b border-border-color p-4 shadow-sm flex justify-between items-center flex-shrink-0">
                <div><h1 id="channel-name-display" class="font-bold text-lg">Bienvenue !</h1><p id="channel-topic-display" class="text-xs text-secondary">S√©lectionnez un canal.</p></div>
                <div class="flex items-center gap-4">
                    <button id="invite-to-channel-btn" class="hidden p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Inviter des amis"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg></button>
                    <button id="channel-settings-btn" class="hidden p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Param√®tres du canal"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    <button id="notifications-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 relative" title="Notifications"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg><span id="notif-indicator" class="hidden absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white dark:border-gray-800"></span></button>
                    <button id="main-theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Changer de th√®me"></button>
                    <button id="logout-btn" class="bg-red-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-red-600">D√©connexion</button>
                </div>
            </header>
            <main id="message-list" class="flex-grow overflow-y-auto p-4 flex flex-col gap-1 bg-accent"></main>
            <footer id="chat-footer" class="bg-white dark:bg-gray-800 p-4 border-t border-border-color hidden"><form id="chat-form" class="flex items-center gap-3"><input type="text" id="message-input" placeholder="√âcrivez votre message..." class="w-full p-3 border rounded-full bg-accent focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off"><button type="submit" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button></form></footer>
        </div>
    </div>
    
    <!-- #################### MODALES #################### -->
    <div id="add-channel-modal" class="hidden modal-overlay fixed inset-0 z-50 flex items-center justify-center"><div class="modal-content rounded-lg shadow-lg w-full max-w-md"><header class="p-4 flex justify-between items-center border-b border-border-color"><h2 class="text-lg font-bold">Canaux</h2><button class="close-modal-btn text-2xl font-bold">&times;</button></header><div class="p-6"><div class="flex border-b border-border-color mb-4"><button id="create-tab-btn" class="tab flex-1 py-2 font-semibold">Cr√©er</button><button id="join-tab-btn" class="tab flex-1 py-2 font-semibold text-secondary">Rejoindre</button></div><form id="create-channel-form" class="space-y-3"><input id="new-channel-name" type="text" placeholder="Nom du canal" class="w-full p-2 border rounded modal-input" required><input id="new-channel-icon" type="url" placeholder="URL de l'ic√¥ne (facultatif)" class="w-full p-2 border rounded modal-input"><div class="flex items-center gap-2"><input id="new-channel-private" type="checkbox" class="h-4 w-4"><label for="new-channel-private">Canal Priv√© (sur invitation uniquement)</label></div><button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded hover:bg-green-700">Cr√©er le canal</button></form><form id="join-channel-form" class="hidden space-y-3"><input id="join-channel-code" type="text" placeholder="Code d'invitation" class="w-full p-2 border rounded modal-input" required><button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded hover:bg-blue-700">Rejoindre le canal</button></form></div></div></div>
    <div id="invitations-modal" class="hidden modal-overlay fixed inset-0 z-50 flex items-center justify-center"><div class="modal-content rounded-lg shadow-lg w-full max-w-md"><header class="p-4 flex justify-between items-center border-b border-border-color"><h2 class="text-lg font-bold">Invitations</h2><button class="close-modal-btn text-2xl font-bold">&times;</button></header><div id="invitations-list" class="p-6 space-y-3 max-h-96 overflow-y-auto"></div></div></div>
    <div id="edit-profile-modal" class="hidden modal-overlay fixed inset-0 z-50 flex items-center justify-center"><div class="modal-content rounded-lg shadow-lg w-full max-w-md"><header class="p-4 flex justify-between items-center border-b border-border-color"><h2 class="text-lg font-bold">Modifier le profil</h2><button class="close-modal-btn text-2xl font-bold">&times;</button></header><div class="p-6"><form id="edit-profile-form" class="space-y-3"><input id="edit-displayname" type="text" placeholder="Nouveau nom d'affichage" class="w-full p-2 border rounded modal-input" required><input id="edit-pfp" type="url" placeholder="Nouvelle URL d'image" class="w-full p-2 border rounded modal-input"><button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded hover:bg-blue-700">Sauvegarder</button></form></div></div></div>
    <div id="edit-channel-modal" class="hidden modal-overlay fixed inset-0 z-50 flex items-center justify-center"><div class="modal-content rounded-lg shadow-lg w-full max-w-md"><header class="p-4 flex justify-between items-center border-b border-border-color"><h2 class="text-lg font-bold">Param√®tres du canal</h2><button class="close-modal-btn text-2xl font-bold">&times;</button></header><div class="p-6 max-h-[80vh] overflow-y-auto"><form id="edit-channel-form" class="space-y-3"><input id="edit-channel-name" type="text" placeholder="Nouveau nom" class="w-full p-2 border rounded modal-input" required><input id="edit-channel-icon" type="url" placeholder="Nouvelle URL d'ic√¥ne" class="w-full p-2 border rounded modal-input"><button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded hover:bg-blue-700">Sauvegarder</button></form><hr class="my-4"><div id="member-management-section" class="space-y-2"></div><hr class="my-4"><div class="space-y-2"><h3 class="font-bold text-red-500">Zone de Danger</h3><p class="text-sm text-secondary">Supprimer un canal est une action irr√©versible.</p><input type="text" id="delete-channel-confirm" placeholder="Entrez le nom du canal pour confirmer" class="w-full p-2 border rounded modal-input border-red-300"><button id="delete-channel-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded hover:bg-red-700 disabled:bg-gray-400" disabled>Supprimer ce canal</button></div></div></div></div>
    <div id="friends-modal" class="hidden modal-overlay fixed inset-0 z-50 flex items-center justify-center"><div class="modal-content rounded-lg shadow-lg w-full max-w-lg"><header class="p-4 flex justify-between items-center border-b border-border-color"><h2 class="text-lg font-bold">Amis</h2><button class="close-modal-btn text-2xl font-bold">&times;</button></header><div class="p-6"><div class="flex border-b border-border-color mb-4"><button id="friends-list-tab" class="tab flex-1 py-2 font-semibold">Mes Amis</button><button id="add-friend-tab" class="tab flex-1 py-2 font-semibold text-secondary">Ajouter</button></div><div id="friends-list-content"></div><form id="add-friend-form" class="hidden space-y-3"><input id="add-friend-username" type="text" placeholder="Pseudo de l'utilisateur" class="w-full p-2 border rounded modal-input" required><button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded hover:bg-green-700">Envoyer une demande d'ami</button></form></div></div></div>
    <div id="invite-to-channel-modal" class="hidden modal-overlay fixed inset-0 z-50 flex items-center justify-center"><div class="modal-content rounded-lg shadow-lg w-full max-w-md"><header class="p-4 flex justify-between items-center border-b border-border-color"><h2 class="text-lg font-bold">Inviter des amis</h2><button class="close-modal-btn text-2xl font-bold">&times;</button></header><div id="invite-friends-list" class="p-6 space-y-2 max-h-96 overflow-y-auto"></div></div></div>
    <div id="user-profile-modal" class="hidden modal-overlay fixed inset-0 z-50 flex items-center justify-center"><div id="user-profile-content" class="modal-content rounded-lg shadow-lg w-full max-w-sm p-6 text-center"></div></div>

    <!-- #################### SCRIPT #################### -->
    <script type="module">
        // --- Imports Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, updateDoc, getDoc, getDocs, writeBatch, where, arrayUnion, deleteDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration et Initialisation ---
        const firebaseConfig = { apiKey: "AIzaSyDoejoSEXYWX_QL9-xd-YGS4ouaH3BkZ1I", authDomain: "h3-x-dst.firebaseapp.com", projectId: "h3-x-dst", storageBucket: "h3-x-dst.firebasestorage.app", messagingSenderId: "922426422571", appId: "1:922426422571:web:5a13dd1b75dc07678e016e" };
        let app, db, auth;
        let userId, userDisplayName, userPFP;
        let activeChannelId = null;
        let activeChannelData = null;
        let unsubscribeListeners = [];

        try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) { document.body.innerHTML = `<div class="p-8 text-red-500">Erreur Firebase: ${e.message}</div>`; }
        
        // --- √âl√©ments UI ---
        const ui = { authScreen: document.getElementById('auth-screen'), mainAppScreen: document.getElementById('main-app-screen'), loginForm: document.getElementById('login-form'), signupForm: document.getElementById('signup-form'), loginTabBtn: document.getElementById('login-tab-btn'), signupTabBtn: document.getElementById('signup-tab-btn'), loginError: document.getElementById('login-error'), signupError: document.getElementById('signup-error'), serverList: document.getElementById('server-list'), messageList: document.getElementById('message-list'), channelNameDisplay: document.getElementById('channel-name-display'), channelTopicDisplay: document.getElementById('channel-topic-display'), chatFooter: document.getElementById('chat-footer'), chatForm: document.getElementById('chat-form'), messageInput: document.getElementById('message-input'), logoutBtn: document.getElementById('logout-btn'), notificationsBtn: document.getElementById('notifications-btn'), notifIndicator: document.getElementById('notif-indicator'), addChannelModal: document.getElementById('add-channel-modal'), createChannelForm: document.getElementById('create-channel-form'), joinChannelForm: document.getElementById('join-channel-form'), createTabBtn: document.getElementById('create-tab-btn'), joinTabBtn: document.getElementById('join-tab-btn'), invitationsModal: document.getElementById('invitations-modal'), invitationsList: document.getElementById('invitations-list'), editProfileModal: document.getElementById('edit-profile-modal'), editChannelModal: document.getElementById('edit-channel-modal'), channelSettingsBtn: document.getElementById('channel-settings-btn'), memberManagementSection: document.getElementById('member-management-section'), friendsModal: document.getElementById('friends-modal'), friendsListContent: document.getElementById('friends-list-content'), addFriendForm: document.getElementById('add-friend-form'), friendsListTab: document.getElementById('friends-list-tab'), addFriendTab: document.getElementById('add-friend-tab'), inviteToChannelBtn: document.getElementById('invite-to-channel-btn'), inviteToChannelModal: document.getElementById('invite-to-channel-modal'), inviteFriendsList: document.getElementById('invite-friends-list'), userProfileModal: document.getElementById('user-profile-modal'), userProfileContent: document.getElementById('user-profile-content'), themeToggles: [document.getElementById('auth-theme-toggle'), document.getElementById('main-theme-toggle')] };

        // --- GESTION DE L'AFFICHAGE ET DU TH√àME ---
        const showScreen = (screenName) => { ui.authScreen.classList.add('hidden'); ui.mainAppScreen.classList.add('hidden'); if (screenName === 'auth') { ui.authScreen.classList.remove('hidden'); ui.authScreen.classList.add('flex'); } else if (screenName === 'main') { ui.mainAppScreen.classList.remove('hidden'); ui.mainAppScreen.classList.add('flex'); } };
        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`;
        const applyTheme = (theme) => { document.documentElement.classList.toggle('dark', theme === 'dark'); ui.themeToggles.forEach(toggle => { toggle.innerHTML = theme === 'dark' ? sunIcon : moonIcon; }); };
        const toggleTheme = () => { const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; localStorage.setItem('theme', newTheme); applyTheme(newTheme); };
        ui.themeToggles.forEach(toggle => toggle.addEventListener('click', toggleTheme));
        applyTheme(localStorage.getItem('theme') || 'light');

        // --- GESTION DE L'√âTAT DE L'APPLICATION ---
        const cleanupListeners = () => { unsubscribeListeners.forEach(unsubscribe => unsubscribe()); unsubscribeListeners = []; };
        onAuthStateChanged(auth, async (user) => {
            cleanupListeners();
            if (user) { const userDoc = await getDoc(doc(db, "users", user.uid)); if (userDoc.exists()) { userId = user.uid; const data = userDoc.data(); userDisplayName = data.displayName; userPFP = data.pfp; showScreen('main'); setupUserEnvironment(userId); } else { signOut(auth); } } else { userId = null; userDisplayName = null; userPFP = null; activeChannelId = null; showScreen('auth'); }
        });
        const setupUserEnvironment = (uid) => { listenForUserChannels(uid); listenForInvitations(uid); };

        // --- GESTION DES CANAUX ---
        const listenForUserChannels = (uid) => {
            const userDocRef = doc(db, "users", uid);
            const unsubscribe = onSnapshot(userDocRef, async (userDoc) => {
                if (!userDoc) return;
                const userData = userDoc.data() || {};
                userDisplayName = userData.displayName; userPFP = userData.pfp;
                const channelIds = userData.channels || [];

                const previouslyActive = ui.serverList.querySelector('.active')?.dataset.channelId;
                ui.serverList.innerHTML = '';
                if (channelIds.length > 0) { for (const channelId of channelIds) { const channelDoc = await getDoc(doc(db, "channels", channelId)); if (channelDoc.exists()) { renderChannelIcon(channelDoc.id, channelDoc.data()); } } } else { ui.channelNameDisplay.textContent = "Aucun canal"; ui.channelTopicDisplay.textContent = "Cr√©ez ou rejoignez un canal."; ui.messageList.innerHTML = '<div class="text-center text-secondary m-auto">Aucun canal.</div>'; ui.chatFooter.classList.add('hidden'); }
                
                const addBtn = document.createElement('button'); addBtn.className = "server-icon"; addBtn.title="Ajouter un canal"; addBtn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12"x2="19" y2="12"></line></svg>`; addBtn.onclick = () => ui.addChannelModal.classList.remove('hidden'); ui.serverList.appendChild(addBtn);
                const friendsBtn = document.createElement('button'); friendsBtn.className = "server-icon"; friendsBtn.title="Amis"; friendsBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`; friendsBtn.onclick = () => { listenForFriends(userId); ui.friendsModal.classList.remove('hidden'); }; ui.serverList.appendChild(friendsBtn);
                const profileBtn = document.createElement('button'); profileBtn.className = "server-icon mt-auto"; profileBtn.title="Modifier le profil"; profileBtn.innerHTML = `<img src="${userPFP || `https://placehold.co/64x64/e4e6eb/050505?text=${userDisplayName.charAt(0)}`}" class="rounded-full">`; profileBtn.onclick = () => ui.editProfileModal.classList.remove('hidden'); ui.serverList.appendChild(profileBtn);
                
                if (previouslyActive && channelIds.includes(previouslyActive)) { ui.serverList.querySelector(`[data-channel-id="${previouslyActive}"]`).classList.add('active'); }
            });
            unsubscribeListeners.push(unsubscribe);
        };
        const renderChannelIcon = (id, data) => { const icon = document.createElement('button'); icon.className = "server-icon"; icon.dataset.channelId = id; if (data.iconUrl) { icon.innerHTML = `<img src="${data.iconUrl}" alt="${data.name}" class="rounded-full">`; } else { icon.textContent = data.name.charAt(0).toUpperCase(); } icon.addEventListener('click', () => switchActiveChannel(id)); ui.serverList.appendChild(icon); };
        const switchActiveChannel = (id) => {
            if (activeChannelId === id) return;
            activeChannelId = id;
            unsubscribeListeners = unsubscribeListeners.filter(unsub => !unsub.isChannelSpecific);
            
            document.querySelectorAll('.server-icon').forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-channel-id="${id}"]`).classList.add('active');
            
            const channelDocRef = doc(db, "channels", id);
            const unsubChannelData = onSnapshot(channelDocRef, (docSnap) => {
                if (!docSnap.exists()) { activeChannelId = null; return; }
                activeChannelData = docSnap.data();
                ui.channelNameDisplay.textContent = activeChannelData.name;
                ui.channelTopicDisplay.textContent = activeChannelData.isPublic ? `Code d'invitation: ${activeChannelData.inviteCode}` : "Canal priv√©";
                ui.chatFooter.classList.remove('hidden');
                ui.channelSettingsBtn.classList.toggle('hidden', activeChannelData.ownerId !== userId);
                ui.inviteToChannelBtn.classList.toggle('hidden', activeChannelData.isPublic);
            });
            unsubChannelData.isChannelSpecific = true;
            unsubscribeListeners.push(unsubChannelData);
            
            listenForMessages(`/channels/${id}/messages`);
        };
        
        // --- GESTION DES MESSAGES (Style iMessage) ---
        const listenForMessages = (path) => {
            ui.messageList.innerHTML = '<div class="text-center text-secondary m-auto">Chargement...</div>';
            const q = query(collection(db, path), orderBy("timestamp"));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                if(snapshot.metadata.hasPendingWrites) return;
                ui.messageList.innerHTML = '';
                if (snapshot.empty) { ui.messageList.innerHTML = '<div class="text-center text-secondary m-auto">Aucun message. Soyez le premier !</div>'; return; }
                snapshot.forEach(docSnap => renderMessage(docSnap.data()));
                ui.messageList.scrollTop = ui.messageList.scrollHeight;
            });
            unsubscribe.isChannelSpecific = true;
            unsubscribeListeners.push(unsubscribe);
        };
        const renderMessage = (data) => {
            const isMyMessage = data.senderId === userId;
            const row = document.createElement('div');
            row.className = `message-row ${isMyMessage ? 'my-message' : 'other-message'}`;
            const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '';
            const avatar = `<img src="${data.pfp || `https://placehold.co/64x64/e4e6eb/050505?text=${data.displayName.charAt(0)}`}" class="message-avatar" data-user-id="${data.senderId}">`;
            row.innerHTML = `<div class="message-content">${!isMyMessage ? `<div class="message-pseudo" data-user-id="${data.senderId}">${data.displayName}</div>` : ''}<div class="message-bubble">${data.text}</div><div class="message-time">${time}</div></div>`;
            if (!isMyMessage) row.insertAdjacentHTML('afterbegin', avatar);
            ui.messageList.appendChild(row);
        };
        ui.chatForm.addEventListener('submit', async (e) => { e.preventDefault(); const text = ui.messageInput.value.trim(); if (!text || !activeChannelId) return; try { await addDoc(collection(db, `/channels/${activeChannelId}/messages`), { text, senderId: userId, displayName: userDisplayName, pfp: userPFP, timestamp: serverTimestamp() }); ui.messageInput.value = ''; } catch (error) { console.error("Message send error:", error); } });
        ui.messageList.addEventListener('click', (e) => { const targetUserId = e.target.dataset.userId; if (targetUserId) { showUserProfile(targetUserId); } });

        // --- LOGIQUE DE CR√âATION/REJOINTE/MODIFICATION ---
        const generateInviteCode = () => Array(8).fill(0).map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[Math.floor(Math.random() * 62)]).join('');
        ui.createChannelForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = document.getElementById('new-channel-name').value; const iconUrl = document.getElementById('new-channel-icon').value; const isPrivate = document.getElementById('new-channel-private').checked; if (!name.trim()) return; try { const inviteCode = generateInviteCode(); const newChannelRef = await addDoc(collection(db, "channels"), { name, iconUrl, ownerId: userId, createdAt: serverTimestamp(), inviteCode, isPublic: !isPrivate, bannedUsers: [] }); const channelId = newChannelRef.id; await setDoc(doc(db, `channels/${channelId}/members`, userId), { displayName: userDisplayName, role: 'owner', joinedAt: serverTimestamp() }); await updateDoc(doc(db, "users", userId), { channels: arrayUnion(channelId) }); ui.addChannelModal.classList.add('hidden'); e.target.reset(); } catch (error) { alert("Impossible de cr√©er le canal."); } });
        ui.joinChannelForm.addEventListener('submit', async (e) => { e.preventDefault(); const code = document.getElementById('join-channel-code').value.trim(); if (!code) return; try { const q = query(collection(db, "channels"), where("inviteCode", "==", code)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { alert("Aucun canal trouv√© avec ce code."); return; } const channelDoc = querySnapshot.docs[0]; const channelData = channelDoc.data(); if (!channelData.isPublic) { alert("Ce canal est priv√© et requiert une invitation."); return; } if (channelData.bannedUsers.includes(userId)) { alert("Vous avez √©t√© banni de ce canal."); return; } const channelId = channelDoc.id; await updateDoc(doc(db, "users", userId), { channels: arrayUnion(channelId) }); await setDoc(doc(db, `channels/${channelId}/members`, userId), { displayName: userDisplayName, role: 'member', joinedAt: serverTimestamp() }); ui.addChannelModal.classList.add('hidden'); e.target.reset(); } catch (error) { alert("Impossible de rejoindre le canal."); } });
        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => { e.preventDefault(); const newDisplayName = document.getElementById('edit-displayname').value; const newPfp = document.getElementById('edit-pfp').value; try { await updateDoc(doc(db, "users", userId), { displayName: newDisplayName, pfp: newPfp }); ui.editProfileModal.classList.add('hidden'); } catch (error) { alert("Erreur de mise √† jour."); } });
        document.getElementById('edit-channel-form').addEventListener('submit', async (e) => { e.preventDefault(); const newName = document.getElementById('edit-channel-name').value; const newIcon = document.getElementById('edit-channel-icon').value; if (!activeChannelId) return; try { await updateDoc(doc(db, "channels", activeChannelId), { name: newName, iconUrl: newIcon }); ui.editChannelModal.classList.add('hidden'); } catch (error) { alert("Erreur de mise √† jour."); } });
        ui.channelSettingsBtn.addEventListener('click', () => { listenForChannelMembers(activeChannelId); ui.editChannelModal.classList.remove('hidden'); });
        
        // --- LOGIQUE DE SUPPRESSION ---
        const deleteConfirmInput = document.getElementById('delete-channel-confirm');
        const deleteBtn = document.getElementById('delete-channel-btn');
        deleteConfirmInput.addEventListener('input', () => { deleteBtn.disabled = deleteConfirmInput.value !== activeChannelData.name; });
        deleteBtn.addEventListener('click', async () => {
            if (!activeChannelId || !activeChannelData || deleteConfirmInput.value !== activeChannelData.name) return;
            deleteBtn.disabled = true; deleteBtn.textContent = 'Suppression...';
            try {
                const membersQuery = await getDocs(collection(db, `channels/${activeChannelId}/members`));
                const memberIds = membersQuery.docs.map(d => d.id);
                
                const batch = writeBatch(db);
                const messagesQuery = await getDocs(collection(db, `channels/${activeChannelId}/messages`));
                messagesQuery.forEach(d => batch.delete(d.ref));
                membersQuery.forEach(d => batch.delete(d.ref));
                batch.delete(doc(db, "channels", activeChannelId));
                await batch.commit();

                for (const memberId of memberIds) {
                    await updateDoc(doc(db, 'users', memberId), { channels: arrayRemove(activeChannelId) });
                }
                
                ui.editChannelModal.classList.add('hidden');
                activeChannelId = null;
            } catch (error) { console.error(error); alert('Erreur lors de la suppression.'); deleteBtn.disabled = false; deleteBtn.textContent = 'Supprimer ce canal'; }
        });

        // --- GESTION DES AMIS ET R√îLES ---
        ui.addFriendForm.addEventListener('submit', async (e) => { e.preventDefault(); const targetUsername = document.getElementById('add-friend-username').value.trim(); if (!targetUsername || targetUsername.toLowerCase() === userDisplayName.toLowerCase()) return; try { const q = query(collection(db, "usernames"), where("id", "==", targetUsername.toLowerCase())); const userSnapshot = await getDocs(q); if (userSnapshot.empty) { alert("Utilisateur non trouv√©."); return; } const targetUser = userSnapshot.docs[0].data(); const targetId = targetUser.uid; const friendRef = doc(db, `users/${userId}/friends/${targetId}`); await setDoc(friendRef, { status: 'pending', since: serverTimestamp() }); const targetRef = doc(db, `users/${targetId}/friends/${userId}`); await setDoc(targetRef, { status: 'received', since: serverTimestamp() }); alert('Demande envoy√©e !'); e.target.reset(); } catch (error) { alert("Erreur lors de l'ajout."); } });
        const listenForFriends = (uid) => { const friendsRef = collection(db, `users/${uid}/friends`); const unsubscribe = onSnapshot(friendsRef, async (snapshot) => { const sections = { accepted: [], pending: [], received: [] }; for (const docSnap of snapshot.docs) { const friendId = docSnap.id; const friendData = docSnap.data(); const userDoc = await getDoc(doc(db, 'users', friendId)); if (userDoc.exists()) { sections[friendData.status].push({ id: friendId, ...userDoc.data(), ...friendData }); } } renderFriendsList(sections); }); unsubscribeListeners.push(unsubscribe); };
        const renderFriendsList = (sections) => { ui.friendsListContent.innerHTML = `<h3 class="font-semibold mt-4">Amis (${sections.accepted.length})</h3><div class="space-y-2">${sections.accepted.map(f => `<div class="p-2 bg-accent rounded flex justify-between items-center"><span>${f.displayName}</span></div>`).join('') || '<p class="text-sm text-secondary">Aucun ami.</p>'}</div><h3 class="font-semibold mt-4">En attente (${sections.pending.length})</h3><div class="space-y-2">${sections.pending.map(f => `<div class="p-2 bg-accent rounded"><span>${f.displayName}</span></div>`).join('') || '<p class="text-sm text-secondary">Aucune demande.</p>'}</div><h3 class="font-semibold mt-4">Demandes re√ßues (${sections.received.length})</h3><div class="space-y-2">${sections.received.map(f => `<div class="p-2 bg-accent rounded flex justify-between items-center"><span>${f.displayName}</span><div class="flex gap-2"><button data-action="accept" data-id="${f.id}" class="bg-green-500 text-white px-2 py-1 rounded text-xs">‚úì</button><button data-action="decline" data-id="${f.id}" class="bg-red-500 text-white px-2 py-1 rounded text-xs">‚úó</button></div></div>`).join('') || '<p class="text-sm text-secondary">Aucune demande.</p>'}</div>`; };
        ui.friendsListContent.addEventListener('click', async (e) => { const action = e.target.dataset.action; const id = e.target.dataset.id; if (!action || !id) return; const batch = writeBatch(db); const myFriendRef = doc(db, `users/${userId}/friends/${id}`); const theirFriendRef = doc(db, `users/${id}/friends/${userId}`); if (action === 'accept') { batch.update(myFriendRef, { status: 'accepted' }); batch.update(theirFriendRef, { status: 'accepted' }); } else { batch.delete(myFriendRef); batch.delete(theirFriendRef); } await batch.commit(); });
        const listenForChannelMembers = (channelId) => { const membersRef = collection(db, `channels/${channelId}/members`); const unsubscribe = onSnapshot(membersRef, (snapshot) => { renderMemberManagement(snapshot); }); unsubscribe.isChannelSpecific = true; unsubscribeListeners.push(unsubscribe); };
        const renderMemberManagement = (snapshot) => {
            ui.memberManagementSection.innerHTML = `<h3 class="font-bold">Gestion des Membres</h3>`;
            const members = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            const myRole = members.find(m => m.id === userId)?.role;
            members.forEach(member => {
                const div = document.createElement('div');
                div.className = 'p-2 bg-accent rounded flex justify-between items-center';
                let buttons = '';
                if (myRole === 'owner' && member.id !== userId) { buttons += `<button data-action="role" data-id="${member.id}" data-role="${member.role === 'admin' ? 'member' : 'admin'}" class="bg-gray-500 text-white px-2 py-1 rounded text-xs">${member.role === 'admin' ? 'R√©trograder' : 'Promouvoir'}</button>`; }
                if ((myRole === 'owner' || myRole === 'admin') && member.role !== 'owner') { buttons += `<button data-action="kick" data-id="${member.id}" class="bg-yellow-500 text-white px-2 py-1 rounded text-xs ml-2">Kick</button><button data-action="ban" data-id="${member.id}" class="bg-red-700 text-white px-2 py-1 rounded text-xs ml-2">Ban</button>`; }
                div.innerHTML = `<span>${member.displayName} <span class="text-xs text-secondary">${member.role}</span></span><div class="flex">${buttons}</div>`;
                ui.memberManagementSection.appendChild(div);
            });
        };
        ui.memberManagementSection.addEventListener('click', async (e) => { const { action, id, role } = e.target.dataset; if (!action || !id) return; const memberRef = doc(db, `channels/${activeChannelId}/members/${id}`); if (action === 'role') { await updateDoc(memberRef, { role }); } else if (action === 'kick') { await deleteDoc(memberRef); await updateDoc(doc(db, 'users', id), { channels: arrayRemove(activeChannelId) }); } else if (action === 'ban') { await deleteDoc(memberRef); await updateDoc(doc(db, 'users', id), { channels: arrayRemove(activeChannelId) }); await updateDoc(doc(db, 'channels', activeChannelId), { bannedUsers: arrayUnion(id) }); } });

        // --- GESTION DES INVITATIONS ---
        const listenForInvitations = (uid) => { const q = query(collection(db, "invitations"), where("inviteeId", "==", uid), where("status", "==", "pending")); const unsubscribe = onSnapshot(q, (snapshot) => { ui.notifIndicator.classList.toggle('hidden', snapshot.empty); ui.invitationsList.innerHTML = ''; if(snapshot.empty) { ui.invitationsList.innerHTML = '<p class="text-secondary">Aucune nouvelle invitation.</p>'; return; } snapshot.forEach(docSnap => renderInvitation(docSnap.id, docSnap.data())); }); unsubscribeListeners.push(unsubscribe); };
        const renderInvitation = (id, data) => { const div = document.createElement('div'); div.className = 'p-3 bg-accent rounded-lg flex justify-between items-center'; div.innerHTML = `<div><p>Invitation de <strong>${data.inviterDisplayName}</strong></p><p class="text-sm text-secondary">√† rejoindre "${data.channelName}"</p></div><div class="flex gap-2"><button data-action="accept" class="bg-green-500 text-white px-3 py-1 rounded">‚úì</button><button data-action="decline" class="bg-red-500 text-white px-3 py-1 rounded">‚úó</button></div>`; div.addEventListener('click', async (e) => { const action = e.target.dataset.action; if (!action) return; e.target.closest('div').innerHTML = 'Traitement...'; if (action === 'accept') { await updateDoc(doc(db, `users/${userId}`), { channels: arrayUnion(data.channelId) }); await setDoc(doc(db, `channels/${data.channelId}/members/${userId}`), { displayName: userDisplayName, role: 'member', joinedAt: serverTimestamp() }); } await updateDoc(doc(db, `invitations/${id}`), { status: action }); }); ui.invitationsList.appendChild(div); };
        ui.notificationsBtn.addEventListener('click', () => ui.invitationsModal.classList.remove('hidden'));
        ui.inviteToChannelBtn.addEventListener('click', async () => { const friendsRef = collection(db, `users/${userId}/friends`); const q = query(friendsRef, where("status", "==", "accepted")); const snapshot = await getDocs(q); ui.inviteFriendsList.innerHTML = ''; snapshot.forEach(async docSnap => { const friendId = docSnap.id; const friendDoc = await getDoc(doc(db, 'users', friendId)); if (!friendDoc.exists()) return; const friend = friendDoc.data(); const div = document.createElement('div'); div.className = 'p-2 bg-accent rounded flex justify-between items-center'; div.innerHTML = `<span>${friend.displayName}</span><button data-id="${friendId}" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Inviter</button>`; ui.inviteFriendsList.appendChild(div); }); ui.inviteToChannelModal.classList.remove('hidden'); });
        ui.inviteFriendsList.addEventListener('click', async (e) => { const targetId = e.target.dataset.id; if (!targetId || !activeChannelData) return; try { await addDoc(collection(db, 'invitations'), { channelId: activeChannelId, channelName: activeChannelData.name, inviterId: userId, inviterDisplayName: userDisplayName, inviteeId: targetId, status: 'pending', createdAt: serverTimestamp() }); e.target.textContent = 'Invit√©!'; e.target.disabled = true; } catch (err) { alert('Erreur lors de l\'envoi.'); } });

        // --- GESTION DES PROFILS UTILISATEUR ---
        const showUserProfile = async (targetUserId) => {
            const userDoc = await getDoc(doc(db, 'users', targetUserId));
            if (!userDoc.exists()) return;
            const userData = userDoc.data();
            
            let badgesHTML = (userData.badges || []).map(badgeId => renderBadge(badgeId)).join('');
            
            // Check for channel-specific roles
            if (activeChannelId) {
                const memberDoc = await getDoc(doc(db, `channels/${activeChannelId}/members/${targetUserId}`));
                if (memberDoc.exists()) {
                    const memberData = memberDoc.data();
                    if (memberData.role === 'owner') badgesHTML += renderBadge('founder');
                    if (memberData.role === 'admin') badgesHTML += renderBadge('admin');
                }
            }

            ui.userProfileContent.innerHTML = `
                <img src="${userData.pfp || `https://placehold.co/128x128/e4e6eb/050505?text=${userData.displayName.charAt(0)}`}" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-secondary">
                <h2 class="text-xl font-bold">${userData.displayName}</h2>
                <p class="text-sm text-secondary mb-4">@${userData.username}</p>
                <div class="flex justify-center gap-2 flex-wrap">${badgesHTML}</div>
            `;
            ui.userProfileModal.classList.remove('hidden');
        };
        const renderBadge = (badgeId) => {
            const badges = {
                founder: { icon: 'üëë', text: 'Fondateur', color: 'bg-yellow-400' },
                admin: { icon: 'üõ°Ô∏è', text: 'Admin', color: 'bg-blue-500' },
                verified: { icon: '‚úîÔ∏è', text: 'V√©rifi√©', color: 'bg-green-500' },
                active: { icon: 'üî•', text: 'Membre Actif', color: 'bg-orange-500' }
            };
            const badge = badges[badgeId];
            if (!badge) return '';
            return `<span class="text-xs font-semibold text-white ${badge.color} px-2 py-1 rounded-full flex items-center gap-1">${badge.icon} ${badge.text}</span>`;
        };

        // --- GESTION DES MODALES ET ONGLETS ---
        document.querySelectorAll('.close-modal-btn, .modal-overlay').forEach(el => { el.addEventListener('click', (e) => { if (e.target !== el) return; el.closest('.modal-overlay').classList.add('hidden'); }); });
        const switchTab = (activeBtn, inactiveBtn, activeContent, inactiveContent) => { activeBtn.classList.add('active'); inactiveBtn.classList.remove('active'); activeContent.classList.remove('hidden'); inactiveContent.classList.add('hidden'); };
        ui.createTabBtn.addEventListener('click', () => switchTab(ui.createTabBtn, ui.joinTabBtn, ui.createChannelForm, ui.joinChannelForm));
        ui.joinTabBtn.addEventListener('click', () => switchTab(ui.joinTabBtn, ui.createTabBtn, ui.joinChannelForm, ui.createChannelForm));
        ui.friendsListTab.addEventListener('click', () => switchTab(ui.friendsListTab, ui.addFriendTab, ui.friendsListContent, ui.addFriendForm));
        ui.addFriendTab.addEventListener('click', () => switchTab(ui.addFriendTab, ui.friendsListTab, ui.addFriendForm, ui.friendsListContent));
        switchTab(ui.createTabBtn, ui.joinTabBtn, ui.createChannelForm, ui.joinChannelForm);
        switchTab(ui.friendsListTab, ui.addFriendTab, ui.friendsListContent, ui.addFriendForm);

        // --- AUTHENTIFICATION ---
        const displayAuthError = (el, msg) => { el.textContent = msg; el.classList.remove('hidden'); }; const clearAuthError = (el) => { el.textContent = ''; el.classList.add('hidden'); };
        const switchAuthTab = (activeTab) => { if (activeTab === 'login') { ui.loginTabBtn.classList.add('active'); ui.signupTabBtn.classList.remove('active'); ui.loginForm.classList.remove('hidden'); ui.signupForm.classList.add('hidden'); clearAuthError(ui.signupError); } else { ui.signupTabBtn.classList.add('active'); ui.loginTabBtn.classList.remove('active'); ui.signupForm.classList.remove('hidden'); ui.loginForm.classList.add('hidden'); clearAuthError(ui.loginError); } };
        ui.loginTabBtn.addEventListener('click', () => switchAuthTab('login')); ui.signupTabBtn.addEventListener('click', () => switchAuthTab('signup')); switchAuthTab('login');
        ui.loginForm.addEventListener('submit', async (e) => { e.preventDefault(); clearAuthError(ui.loginError); const username = document.getElementById('login-username').value; const password = document.getElementById('login-password').value; try { const usernameSnap = await getDoc(doc(db, "usernames", username.toLowerCase())); if (!usernameSnap.exists()) throw new Error("auth/user-not-found"); const { email } = (await getDoc(doc(db, "users", usernameSnap.data().uid))).data(); await signInWithEmailAndPassword(auth, email, password); } catch (error) { displayAuthError(ui.loginError, "Le pseudo ou le mot de passe est incorrect."); } });
        ui.signupForm.addEventListener('submit', async (e) => { e.preventDefault(); clearAuthError(ui.signupError); const username = document.getElementById('signup-username').value; const displayName = document.getElementById('signup-displayname').value; const password = document.getElementById('signup-password').value; const pfp = document.getElementById('signup-pfp').value; if (!/^[a-zA-Z0-9_]{2,16}$/.test(username)) { return displayAuthError(ui.signupError, "Pseudo unique invalide (lettres, chiffres, _)."); } try { const usernameSnap = await getDoc(doc(db, "usernames", username.toLowerCase())); if (usernameSnap.exists()) return displayAuthError(ui.signupError, "Ce pseudo unique est d√©j√† utilis√©."); const dummyEmail = `${username.toLowerCase()}@chat.app`; const userCredential = await createUserWithEmailAndPassword(auth, dummyEmail, password); const batch = writeBatch(db); batch.set(doc(db, "users", userCredential.user.uid), { username: username.toLowerCase(), displayName, pfp, email: dummyEmail, channels: [], badges: ['active'] }); batch.set(doc(db, "usernames", username.toLowerCase()), { uid: userCredential.user.uid }); await batch.commit(); } catch (error) { if (error.code === 'auth/weak-password') { displayAuthError(ui.signupError, "Le mot de passe doit faire au moins 6 caract√®res."); } else { displayAuthError(ui.signupError, "Erreur lors de la cr√©ation du compte."); } } });
        ui.logoutBtn.addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>
