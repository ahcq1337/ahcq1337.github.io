<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Avancé</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f0f2f5; --bg-secondary: #ffffff; --bg-tertiary: #e4e6eb; --bg-accent: #f0f2f5;
            --text-primary: #050505; --text-secondary: #6b7280; --border-color: #e2e8f0;
            --my-message-bg: #0084ff; --my-message-text: #ffffff;
            --other-message-bg: #e4e6eb; --other-message-text: #050505;
        }
        html.dark {
            --bg-main: #18191a; --bg-secondary: #242526; --bg-tertiary: #3a3b3c; --bg-accent: #3a3b3c;
            --text-primary: #e4e6eb; --text-secondary: #b0b3b8; --border-color: #3a3b3c;
            --my-message-bg: #2d88ff; --my-message-text: #ffffff;
            --other-message-bg: #3a3b3c; --other-message-text: #e4e6eb;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); overflow: hidden; }
        .server-icon { width: 3rem; height: 3rem; background-color: var(--bg-tertiary); border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.5rem; cursor: pointer; transition: all 0.2s ease-in-out; }
        .server-icon:hover, .server-icon.active { border-radius: 1rem; }
        .server-icon.active { border: 2px solid var(--my-message-bg); }
        .server-icon img { width: 100%; height: 100%; object-fit: cover; }
        .modal-content { background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary); }
        .modal-overlay { background-color: rgba(0,0,0,0.6); }
        #message-list, #server-list { scrollbar-width: thin; scrollbar-color: var(--bg-tertiary) transparent; }
    </style>
</head>
<body>

    <div id="auth-screen" class="flex items-center justify-center h-screen">
        <div class="modal-content p-8 rounded-xl shadow-lg w-full max-w-sm">
            <div class="flex justify-center mb-6">
                <img src="https://placehold.co/150x50/ffffff/050505?text=ChatApp" alt="Logo" class="block dark:hidden h-12">
                <img src="https://placehold.co/150x50/242526/e4e6eb?text=ChatApp" alt="Logo" class="hidden dark:block h-12">
            </div>
            <div class="flex border-b mb-6">
                <button id="login-tab-btn" class="flex-1 py-2 font-semibold border-b-2 border-blue-500 text-blue-500">Se Connecter</button>
                <button id="signup-tab-btn" class="flex-1 py-2 font-semibold text-gray-500">Créer un compte</button>
            </div>
            <form id="login-form">
                <p id="login-error" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                <input type="text" id="login-pseudo" placeholder="Pseudo" class="w-full p-3 border rounded-lg mb-4 bg-gray-100 dark:bg-gray-800" required>
                <input type="password" id="login-password" placeholder="Mot de passe" class="w-full p-3 border rounded-lg mb-4 bg-gray-100 dark:bg-gray-800" required>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700">Se connecter</button>
            </form>
            <form id="signup-form" class="hidden">
                <p id="signup-error" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                <input type="text" id="signup-pseudo" placeholder="Pseudo (2-16 caractères, sans espaces)" class="w-full p-3 border rounded-lg mb-4 bg-gray-100 dark:bg-gray-800" required>
                <input type="password" id="signup-password" placeholder="Mot de passe" class="w-full p-3 border rounded-lg mb-4 bg-gray-100 dark:bg-gray-800" required>
                <input type="url" id="signup-pfp" placeholder="URL de l'image (facultatif)" class="w-full p-3 border rounded-lg mb-4 bg-gray-100 dark:bg-gray-800">
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700">Créer le compte</button>
            </form>
        </div>
    </div>

    <div id="main-app-screen" class="hidden h-screen w-screen flex text-primary">
        <nav id="server-list" class="w-20 bg-gray-200 dark:bg-gray-900 p-3 flex flex-col items-center gap-3 overflow-y-auto">
            </nav>

        <div id="chat-container" class="flex-grow flex flex-col bg-secondary">
            <header class="bg-white dark:bg-gray-800 border-b border-gray-300 dark:border-gray-700 p-4 shadow-sm flex justify-between items-center flex-shrink-0">
                <div>
                    <h1 id="channel-name-display" class="font-bold text-lg">Bienvenue !</h1>
                    <p id="channel-topic-display" class="text-xs text-secondary">Sélectionnez un canal ou créez-en un.</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="notifications-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                        <span id="notif-indicator" class="hidden absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white dark:border-gray-800"></span>
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                        <svg id="theme-icon-moon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                    </button>
                    <button id="logout-btn" class="bg-red-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Déconnexion</button>
                </div>
            </header>

            <main id="message-list" class="flex-grow overflow-y-auto p-4 flex flex-col gap-2 bg-gray-100 dark:bg-gray-700">
                <div class="text-center text-secondary m-auto">Sélectionnez un canal pour commencer à discuter.</div>
            </main>
            
            <footer id="chat-footer" class="bg-white dark:bg-gray-800 p-4 border-t border-gray-300 dark:border-gray-700 hidden">
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="text" id="message-input" placeholder="Écrivez votre message..." class="w-full p-3 border rounded-full bg-gray-100 dark:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700"><svg width="24" height="24" viewBox="0 0 24 24"><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
                </form>
            </footer>
        </div>
    </div>
    
    <div id="add-channel-modal" class="hidden modal-overlay fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content rounded-lg shadow-lg w-full max-w-md">
            <header class="p-4 flex justify-between items-center border-b">
                <h2 class="text-lg font-bold">Créer ou rejoindre un canal</h2>
                <button class="close-modal-btn text-2xl font-bold">&times;</button>
            </header>
            <div class="p-6">
                <h3 class="font-semibold mb-2">Créer un nouveau canal</h3>
                <form id="create-channel-form" class="space-y-3">
                    <input id="new-channel-name" type="text" placeholder="Nom du canal" class="w-full p-2 border rounded bg-accent" required>
                    <input id="new-channel-icon" type="url" placeholder="URL de l'icône (facultatif)" class="w-full p-2 border rounded bg-accent">
                    <div class="flex items-center gap-2">
                        <input id="new-channel-public" type="checkbox" class="h-4 w-4">
                        <label for="new-channel-public">Canal Public</label>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded hover:bg-green-700">Créer</button>
                </form>
                <hr class="my-6">
                <h3 class="font-semibold mb-2">Rejoindre un canal public (Bientôt disponible)</h3>
                 <p class="text-sm text-secondary">Cette fonctionnalité est en cours de développement.</p>
            </div>
        </div>
    </div>

    <div id="invitations-modal" class="hidden modal-overlay fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content rounded-lg shadow-lg w-full max-w-md">
            <header class="p-4 flex justify-between items-center border-b">
                <h2 class="text-lg font-bold">Invitations</h2>
                <button class="close-modal-btn text-2xl font-bold">&times;</button>
            </header>
            <div id="invitations-list" class="p-6 space-y-3 max-h-96 overflow-y-auto">
                </div>
        </div>
    </div>
    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, updateDoc, getDoc, writeBatch, where, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration Firebase ---
        const firebaseConfig = {
         apiKey: "AIzaSyDoejoSEXYWX_QL9-xd-YGS4ouaH3BkZ1I",
         authDomain: "h3-x-dst.firebaseapp.com",
         projectId: "h3-x-dst",
         storageBucket: "h3-x-dst.firebasestorage.app",
         messagingSenderId: "922426422571",
         appId: "1:922426422571:web:5a13dd1b75dc07678e016e",
        };
        
        // --- Initialisation ---
        let app, db, auth;
        let userId, userPseudo, userPFP;
        let activeChannelId = null;

        // Abonnements Firestore
        let unsubscribeMessages, unsubscribeChannelList, unsubscribeInvitations;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            document.body.innerHTML = `<div class="p-8 text-red-500">Erreur Firebase: ${e.message}</div>`;
        }
        
        // --- Éléments UI ---
        const authScreen = document.getElementById('auth-screen');
        const mainAppScreen = document.getElementById('main-app-screen');
        const serverList = document.getElementById('server-list');
        const messageList = document.getElementById('message-list');
        const channelNameDisplay = document.getElementById('channel-name-display');
        const channelTopicDisplay = document.getElementById('channel-topic-display');
        const chatFooter = document.getElementById('chat-footer');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const logoutBtn = document.getElementById('logout-btn');
        const notificationsBtn = document.getElementById('notifications-btn');
        const notifIndicator = document.getElementById('notif-indicator');
        const addChannelModal = document.getElementById('add-channel-modal');
        const invitationsModal = document.getElementById('invitations-modal');
        const invitationsList = document.getElementById('invitations-list');

        const showScreen = (screen) => {
            authScreen.classList.add('hidden');
            mainAppScreen.classList.add('hidden');
            screen.classList.remove('hidden');
            screen.classList.add('flex');
        };

        // --- GESTION DE L'ÉTAT DE L'APPLICATION ---
        
        function cleanupListeners() {
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeChannelList) unsubscribeChannelList();
            if (unsubscribeInvitations) unsubscribeInvitations();
        }
        
        onAuthStateChanged(auth, async (user) => {
            cleanupListeners();
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userId = user.uid;
                    const data = userDoc.data();
                    userPseudo = data.pseudo;
                    userPFP = data.pfp;
                    showScreen(mainAppScreen);
                    setupUserEnvironment(userId);
                }
            } else {
                userId = null; userPseudo = null; userPFP = null; activeChannelId = null;
                showScreen(authScreen);
            }
        });

        function setupUserEnvironment(uid) {
            listenForUserChannels(uid);
            listenForInvitations(uid);
        }

        // --- GESTION DES CANAUX ---

        function listenForUserChannels(uid) {
            const userDocRef = doc(db, "users", uid);
            unsubscribeChannelList = onSnapshot(userDocRef, async (userDoc) => {
                if (!userDoc.exists()) return;
                const channelIds = userDoc.data().channels || [];
                
                // Sauvegarder l'ancien canal actif pour le restaurer si possible
                const previouslyActive = serverList.querySelector('.active')?.dataset.channelId;
                
                serverList.innerHTML = ''; // Vider la liste
                
                if (channelIds.length > 0) {
                    for (const channelId of channelIds) {
                        const channelDoc = await getDoc(doc(db, "channels", channelId));
                        if (channelDoc.exists()) {
                            renderChannelIcon(channelDoc.id, channelDoc.data());
                        }
                    }
                } else {
                    channelNameDisplay.textContent = "Aucun canal";
                    channelTopicDisplay.textContent = "Créez ou rejoignez un canal pour commencer.";
                    messageList.innerHTML = '<div class="text-center text-secondary m-auto">Aucun canal.</div>';
                    chatFooter.classList.add('hidden');
                }
                
                // Ajouter le bouton "+"
                const addBtn = document.createElement('button');
                addBtn.className = "server-icon mt-auto";
                addBtn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12"x2="19" y2="12"></line></svg>`;
                addBtn.onclick = () => addChannelModal.classList.remove('hidden');
                serverList.appendChild(addBtn);

                // Restaurer le canal actif
                if (previouslyActive && channelIds.includes(previouslyActive)) {
                    serverList.querySelector(`[data-channel-id="${previouslyActive}"]`).classList.add('active');
                }
            });
        }

        function renderChannelIcon(id, data) {
            const icon = document.createElement('button');
            icon.className = "server-icon";
            icon.dataset.channelId = id;
            if (data.iconUrl) {
                icon.innerHTML = `<img src="${data.iconUrl}" alt="${data.name}" class="rounded-full">`;
            } else {
                icon.textContent = data.name.charAt(0).toUpperCase();
            }
            icon.addEventListener('click', () => switchActiveChannel(id, data));
            serverList.appendChild(icon);
        }

        function switchActiveChannel(id, data) {
            if (activeChannelId === id) return;
            activeChannelId = id;
            
            // Mettre à jour l'UI des icônes
            document.querySelectorAll('.server-icon').forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-channel-id="${id}"]`).classList.add('active');

            // Mettre à jour l'en-tête
            channelNameDisplay.textContent = data.name;
            channelTopicDisplay.textContent = `Vous discutez dans #${data.name}`;
            chatFooter.classList.remove('hidden');

            // Changer l'écoute des messages
            if (unsubscribeMessages) unsubscribeMessages();
            listenForMessages(`/channels/${id}/messages`);
        }

        document.getElementById('create-channel-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-channel-name').value;
            const iconUrl = document.getElementById('new-channel-icon').value;
            const isPublic = document.getElementById('new-channel-public').checked;
            if (!name.trim()) return;

            try {
                // Créer le canal
                const newChannelRef = await addDoc(collection(db, "channels"), {
                    name, iconUrl, isPublic, ownerId: userId, createdAt: serverTimestamp()
                });
                
                // Se faire rejoindre automatiquement
                const channelId = newChannelRef.id;
                await setDoc(doc(db, `channels/${channelId}/members`, userId), {
                    pseudo: userPseudo, joinedAt: serverTimestamp()
                });
                await updateDoc(doc(db, "users", userId), {
                    channels: arrayUnion(channelId)
                });
                
                addChannelModal.classList.add('hidden');
                e.target.reset();
            } catch (error) {
                console.error("Erreur de création de canal: ", error);
                alert("Impossible de créer le canal.");
            }
        });

        // --- GESTION DES MESSAGES (adaptée) ---
        function listenForMessages(path) {
            messageList.innerHTML = '<div class="text-center text-secondary m-auto">Chargement...</div>';
            const q = query(collection(db, path), orderBy("timestamp"));
            let firstLoad = true;
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                if (firstLoad) {
                    messageList.innerHTML = '';
                    firstLoad = false;
                }
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        // Logique d'affichage des messages (non modifiée)
                        console.log(change.doc.data());
                    }
                });
                if (snapshot.empty) {
                     messageList.innerHTML = '<div class="text-center text-secondary m-auto">Aucun message. Soyez le premier !</div>';
                }
            });
        }
        
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !activeChannelId) return;

            try {
                const path = `/channels/${activeChannelId}/messages`;
                await addDoc(collection(db, path), {
                    text, senderId: userId, pseudo: userPseudo, pfp: userPFP, timestamp: serverTimestamp()
                });
                messageInput.value = '';
            } catch (error) {
                console.error("Erreur d'envoi de message:", error);
            }
        });
        
        // --- GESTION DES INVITATIONS ---
        function listenForInvitations(uid) {
            const q = query(collection(db, "invitations"), where("inviteeId", "==", uid), where("status", "==", "pending"));
            unsubscribeInvitations = onSnapshot(q, (snapshot) => {
                notifIndicator.classList.toggle('hidden', snapshot.empty);
                invitationsList.innerHTML = '';
                if(snapshot.empty) {
                    invitationsList.innerHTML = '<p class="text-secondary">Aucune nouvelle invitation.</p>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    renderInvitation(docSnap.id, docSnap.data());
                });
            });
        }

        function renderInvitation(id, data) {
            const div = document.createElement('div');
            div.className = 'p-3 bg-accent rounded-lg flex justify-between items-center';
            div.innerHTML = `
                <div>
                    <p>Invitation de <strong>${data.inviterPseudo}</strong></p>
                    <p class="text-sm text-secondary">à rejoindre le canal "${data.channelName}"</p>
                </div>
                <div class="flex gap-2">
                    <button data-action="accept" class="bg-green-500 text-white px-3 py-1 rounded">✓</button>
                    <button data-action="decline" class="bg-red-500 text-white px-3 py-1 rounded">✗</button>
                </div>
            `;
            div.addEventListener('click', async (e) => {
                const action = e.target.dataset.action;
                if (!action) return;
                
                e.target.disabled = true;
                e.target.parentElement.querySelectorAll('button').forEach(b => b.disabled = true);

                if (action === 'accept') {
                    await updateDoc(doc(db, `users/${userId}`), { channels: arrayUnion(data.channelId) });
                    await setDoc(doc(db, `channels/${data.channelId}/members/${userId}`), { pseudo: userPseudo, joinedAt: serverTimestamp() });
                }
                await updateDoc(doc(db, `invitations/${id}`), { status: action });
            });
            invitationsList.appendChild(div);
        }

        notificationsBtn.addEventListener('click', () => invitationsModal.classList.remove('hidden'));

        // --- GESTION DES MODALES ---
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal-overlay').classList.add('hidden');
            });
        });

        // --- AUTRES (Authentification, Thème, etc. - code largement inchangé) ---
        // Le code de la partie authentification (formulaires login/signup) et de la gestion du thème reste le même.
        // ... (collez ici le code des listeners pour loginForm, signupForm, theme-toggle, etc. de la version précédente) ...
        logoutBtn.addEventListener('click', () => signOut(auth));

    </script>
</body>
</html>
